{% extends 'base.html' %}
{% block media %}
    {{ form.media.css }}
    <link rel="stylesheet" href="{{ static('plugins/css/resizable.min.css') }}">
    <link rel="stylesheet" href="{{ static('funix/css/problem-and-submission.css') }}">
{% endblock %}


{% block js_media %}
    <script src="{{static('plugins/js/resizable.min.js')}}" type="text/javascript"></script>
    <script type="text/javascript" src="{{ ACE_URL }}/ace.js"></script>
    {{ form.media.js }}

    {% compress js %}
        {% include 'problem/ace-editor.html' %}
    {% endcompress %}

    <script type="text/javascript" src="{{ static('event.js') }}"></script>
    {% if submission and not submission.is_graded and last_msg %}
        <script type="text/javascript">
            $(function () {
                var blocked = false, request = false;
                var list = $('#test-cases');
                $('#submit-button').addClass('disabled');

                function update() {
                    if (blocked) {
                        request = true;
                        return;
                    }
                    request = false;
                    blocked = true;
                    $.ajax({
                        url: '{{ url('submission_testcases_query') }}',
                        data: {id: '{{ submission.id }}'}
                    }).done(function (data) {
                        list.empty().html(data).find('.toggle').each(function () {
                            register_toggle($(this));
                        });
                        setTimeout(function () {
                            blocked = false;
                            if (request)
                                update();
                        }, 500);
                    }).fail(function (data) {
                        console.log('Failed to update testcases!');
                    });

                    if ($(window).scrollTop() + $(window).height() > $(document).height() - 100)
                        $("html, body").animate({scrollTop: $(document).height()}, 0);
                }

                var receiver = new EventReceiver(
                    "{{ EVENT_DAEMON_LOCATION }}", "{{ EVENT_DAEMON_POLL_LOCATION }}",
                    ['sub_{{ submission.id_secret }}'], {{ last_msg }}, function (message) {
                        switch (message.type) {
                            case 'internal-error':
                            case 'grading-end':
                            case 'compile-error':
                                $('#abort-button').remove();
                                $('#grading-label').remove();
                                $('#submit-button').removeClass('disabled');
                            case 'test-case':
                            case 'grading-begin':
                            case 'processing':
                                update();
                                $('#submit-button').removeClass('disabled');
                        }
                    }
                )
            });
        </script>
    {% endif %}

    {% if submission and not submission.is_graded %}
        <script type="text/javascript">
            $(function () {
                $(document).keydown(function(e) {
                    // Ctrl-Enter or Command-Enter
                    if ((e.metaKey || e.ctrlKey) && e.which == 13) {
                        $('#abort-button form').submit();
                    }
                });
            });
        </script>
    {% endif %}
    
{% endblock %}

{% block body %}

{% if submission %}
{% set is_processing = submission is not none %}
{% endif %}

<div class="problem_container">
    <div class="topbar">
        <span> {% if content_title %}{{ content_title }}{% else %}{{ title }}{% endif %}</span>
    </div>

    <div class="sidebar">
            <a class="active" href="{{request.path}}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>   
            </a>
        
            <a href="{{ url('chronological_submissions', problem.code) }}" title="{{ _('All submissions') }}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>       
            </a>   

            {% if request.user.is_authenticated and submission %}
            <a href="{{ url('user_submissions', problem.code, request.user.username) }}" title="{{ _('My submissions') }}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </a>
            {% endif %}
        
            <a href="#">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                </svg>    
            </a>  
            
            <a href="{{ url('ranked_submissions', problem.code) }}" title="{{ _('Best submissions') }}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                </svg>           
            </a> 
    </div>

    <div class="main">
        <div class="problem_details">
            {% include "problem/problem-details.html" %}
        </div>
    

        <div class="codeplace">
            {% if not request.user.is_authenticated %}
                <div class="login_required_overlay">
                    <div>
                        <p>Login is needed to make submission</p>
                        <a href="{{ url('auth_login') }}?next={{ LOGIN_RETURN_PATH|urlencode }}">{{ _('Login!') }}</a>
                    </div>
                </div>
            {% else %}

                <div class="toolbar">
                    <button id="expand_button" onclick="expandEditor(event)" class="button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                        </svg>
                    </button>

                    <button onclick="clearEditor()" type="button" class="button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        
                        <span>reset</span>
                    </button>
                </div>

                {# uuuuvcomment ***************************************************************** #}
                {# uuuuvcomment ************************ SUBMIT FORM **************************** #}
                {# uuuuvcomment ***************************************************************** #}
                <form id="problem_submit" method="POST">
                    {# uuuuvcomment ------------------------- choose languages ------------------------- #}
                    {% if not no_judges %}
                        <div id="language">
                            {{ form.language.errors }}
                            <div id="language-select">
                                <select id="id_language" name="language">
                                    {% for lang in form.fields.language.queryset %}
                                        <option 
                                            value="{{ lang.id }}" 
                                            data-id="{{ lang.id }}" 
                                            data-name="{{ lang.name }}"
                                            data-info="{{ lang.info }}" 
                                            data-ace="{{ lang.ace }}"
                                            data-judge-info="{{ runtime_versions(lang.runtime_versions()) }}"
                                            {% if lang.id == default_lang.id %}selected{% endif %}
                                        >
                                            {{ lang.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    {% endif %}

                    {# uuuuvcomment ------------------------- warning ------------------------- #}
                    <div class="codeplace_warning">
                        {% if not no_judges %}
                            {% if default_lang not in form.fields.language.queryset %}
                                <div class="alert alert-warning alert-dismissable">
                                    <a class="close">x</a>
                                    <b>{{ _('Warning!') }}</b>
                                    {{ _('Your default language, %(language)s, is unavailable for this problem and has been deselected.', language=bold(default_lang.name)) }}
                                </div>
                            {% endif %}
                    
                            {% if request.in_contest and submission_limit %}
                                {% if submissions_left > 0 %}
                                    <div class="alert alert-warning alert-dismissable">
                                        <a class="close">x</a>
                                        {% trans left=submissions_left -%}
                                            You have {{ left }} submission left
                                            {%- pluralize -%}
                                            You have {{ left }} submissions left
                                        {%- endtrans %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning alert-dismissable">
                                        <a class="close">x</a>
                                        {{ _('You have 0 submissions left') }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </div>

                    {# uuuuvcomment ------------------------- editor ------------------------- #}
                    <div class="codeplace_editor">
                        {% csrf_token %}
                        {{ form.non_field_errors() }}
                        <div id="submit-wrapper">
                            <div id="editor">
                                {{ form.source.errors }}
                                {{ form.source }}
                            </div>
                        </div>
                    </div>

                    {# uuuuvcomment ------------------------- submit button ------------------------- #}
                    {# uuuuvcomment ------------------ or no judge is available --------------------- #}
                    <div class="submitbar">
                        {% if no_judges %}
                            <span style="color: red">{{ _('No judge is available for this problem.') }}</span>
                        {% else %}
                            <div class="submit-bar">
                                <div>
                                    {{ form.judge }}
                                </div>

                                <div class="submitbar_buttons">
                                    <input id="submit-button"  type="submit" value="{% if submission %}{{ _('Resubmit!') }}{% else %}{{ _('Submit') }}{% endif %}" class="button accent"
                                    {% if request.in_contest and submission_limit and not submissions_left %}disabled{% endif %}>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </form>
                {# uuuuvcomment ******************************************************************* #}
                {# uuuuvcomment ************************ REJUDGE FORM ***************************** #}
                {# uuuuvcomment ******************************************************************* #}
                <div class="rejudge_wrapper">
                    {% if submission and perms.judge.rejudge_submission and not submission.is_locked %}
                    {% compress js %}
                        <script type="text/javascript">
                            window.confirm_and_rejudge = function (form) {
                                if (confirm("{{ _('Are you sure you want to rejudge?') }}")) {
                                    console.log(form)
                                    form.submit()
                                }
                            };
                        </script>
                    {% endcompress %}
                    <form id="rejudge_form" action="{{ url('submission_rejudge') }}" method="post">
                        {% csrf_token %}
                        <a href="#" onclick="confirm_and_rejudge(parentNode)" class="button">{{ _('Rejudge') }}</a>
                        <input type="hidden" name="id" value="{{ submission.id }}" />
                        <input type="hidden" name="path" value="{{ url('problem_submit', problem.code) }}" />
                    </form>
                {% endif %}
                </div>
                <div class="submission">
                    {# uuuuvcomment ***************************************************************** #}
                    {# uuuuvcomment ***************************************************************** #}
                    {# uuuuvcomment ************************ TEST CASES ***************************** #}
                    {# uuuuvcomment ***************************************************************** #}
                    {# uuuuvcomment ***************************************************************** #}
                    <ul class="tabs">
                 
                        <li class="tab {% if is_processing == false %}{{'active'}}{% endif %}" onclick="tabHandler(event, 'testcases')" >Test cases</li>
                        <li class="tab {% if is_processing == true %}{{'active'}}{% endif %}" onclick="tabHandler(event, 'submission_results')">Console</li>
                    </ul>

                    <div class="tab_contents">
                        <div id="testcases" class="tab_content {% if is_processing == false %}{{'active'}}{% endif %}">
                            <ul class="tabs">
                                {% for case in testcases_map %}
                                    <li  onclick="tabHandler(event, 'testcase{{case.order}}')" class="tab {% if case.order == 1 %}{{ 'active' }}{% endif %} {% if case.sub_order %}{{'subcase'}}{% endif %}"  >
                                        {% if case.type == 'S' %}
                                            Batch {{case.batch_order}}
                                        {% elif case.sub_order %}
                                            Case {{case.sub_order}}
                                        {% else %}
                                            Test case {{case.batch_order}}
                                        {% endif %}
                                        {% if case.is_pretest == false %}
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                                            </svg>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        
                            {% for case in problem.cases.all() %}
                                {% if case.type != 'E' %}
                                <div id="testcase{{case.order}}" class="tab_content {% if case.order == 1 %}{{ 'active' }}{% endif %}">
                                    <div class="inner">
                                        <p class="testcase_data_item">
                                            <label>Points:</label> 
                                            <span>{{case.points}}</span>
                                        </p>
                                
                                        <div  class="testcase_data_item">
                                            <label>Input:</label> 
                                            {% if case.data and case.is_pretest == true %}
                                               <div class="outer_wrapper">
                                                    <div class="inner_wrapper">
                                                    <pre >
                                                        {{case.data.input_data}}
                                                    </pre>
                                                    </div>
                                               </div>
                                            {% endif %}
                                        </div>
                        
                                        <div class="testcase_data_item">
                                            <label>Expected output:</label>
                                            {% if case.data and case.is_pretest == true %}
                                               <div class="outer_wrapper">
                                                    <div class="inner_wrapper">
                                                    <pre>
                                                        {{case.data.output_data}}
                                                    </pre>
                                                    </div>
                                               </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
 
                        <div id="submission_results" class="tab_content {% if is_processing == true %}{{'active'}}{% endif %}">
                            {% if submission and  not submission.is_graded and (request.user == submission.user.user or perms.judge.abort_any_submission) %}
                                <div id="abort-button" class="d-none" >
                                    {# uuuuvcomment ***************************************************************** #}
                                    {# uuuuvcomment ***************************************************************** #}
                                    {# uuuuvcomment ************************ ABORT FORM ***************************** #}
                                    {# uuuuvcomment ***************************************************************** #}
                                    {# uuuuvcomment ***************************************************************** #}
                                    <form action="{{ url('submission_abort', submission.id) }}" method="post"
                                        title="{{ _('Press Ctrl-Enter or Command-Enter to abort.') }}">
                                        {% csrf_token %}
                                        <input style="float:left" type="submit" value="{{ _('Abort') }}" class="button"/>
                                    </form>
                                </div>
                            {% endif %}
    
                            {% if submission %}
                                <span class="submission-info">
                                    <span class="submission-date">
                                        {# uuuuvcomment ***************************************************************** #}
                                        {# uuuuvcomment ***************************************************************** #}
                                        {# uuuuvcomment ************************ SUBMISSION INFO ************************ #}
                                        {# uuuuvcomment ***************************************************************** #}
                                        {# uuuuvcomment ***************************************************************** #}
                                        {% with date=submission.date|date(_('N j, Y, g:i a')), can_edit=submission.problem.is_editable_by(request.user) %}
                                            {% if can_edit and submission.judged_on %}
                                                {{ _('%(date)s on %(judge)s', date=date, judge=submission.judged_on.name) }}
                                            {% else %}
                                                {{ date }}
                                            {% endif %}
                                            <br>
                                            <span>{{ submission.language }}</span>
                                            {% if can_edit %}
                                                [<a href="{{ url('admin:judge_submission_change', submission.id) }}">{{ _('Admin') }}</a>]
                                            {% endif %}
                                        {% endwith %}
                                    </span>
                                </span>
    
                                {# uuuuvcomment ***************************************************************** #}
                                {# uuuuvcomment ***************************************************************** #}
                                {# uuuuvcomment ************** SUBMISSION RESULT AND LOADING ******************** #}
                                {# uuuuvcomment ***************************************************************** #}
                                {# uuuuvcomment ***************************************************************** #}
                                <div id="test-cases">{% include "problem/submission-status.html" %}</div>
    
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% compress js %}
<script type="text/javascript" >
    // horizontal resizing
    $('.codeplace').resizable({
        direction: ['left']
    })

    // update #ace_source height when and after vertical resizing
    $('.codeplace_editor').resizable({
        direction: ['bottom'],
        resize: () => {
            $('#ace_source').height($('.codeplace_editor').height())
        },
        stop: () => {
            $('#ace_source').height($('.codeplace_editor').height())
            window.aceEditor.resize()
        }
    })

    // set initial height to #ace_source
    $('#ace_source').height($('.codeplace_editor').height());


    // clear code in editor 
    function clearEditor() {
        var source = $('textarea#id_source');
        source.val('') 
        window.ace_source.getSession().setValue('');
    }

    // collapse - expand editor 100% 
    function expandEditor(event) {
        var collapse = 
            `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
            </svg>
            `;
        
        var expand = 
            `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
            </svg>
            `;


        var codeplace = $('.codeplace');
        codeplace.toggleClass('expand')
        if (codeplace.hasClass('expand')) {
            event.target.innerHTML = collapse;
        } else {
            event.target.innerHTML = expand;
        }
    }

    // render resizer buttons
    var vertical = 
        `
        <div class="resizer resizer-v">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="17" height="17" viewBox="0 0 17 17">
                <g></g>
                <path d="M11.642 12.063l0.716 0.698-3.858 3.955-3.858-3.954 0.716-0.698 2.642 2.707v-12.542l-2.642 2.708-0.716-0.699 3.858-3.954 3.858 3.954-0.716 0.698-2.642-2.707v12.543l2.642-2.709z" fill="inherit" />
            </svg>
        </div>
        `;

    var horizontal = 
        `
        <div class="resizer resizer-h">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="17" height="17" viewBox="0 0 17 17">
                <g></g>
                <path d="M16.716 8.5l-3.954 3.858-0.698-0.716 2.707-2.642h-12.542l2.708 2.642-0.698 0.716-3.955-3.858 3.954-3.858 0.698 0.716-2.707 2.642h12.543l-2.708-2.642 0.698-0.716 3.954 3.858z" fill="inherit" />
            </svg>
        </div>
        `;

    $('.codeplace .resizable-l')[0].innerHTML = horizontal;
    $('.codeplace .resizable-b')[0].innerHTML = vertical;

    const displayTestCaseData = (event) =>  {
        const case_order = event.target.id.replace("testcase_title_",'');
        console.log(case_order)

        $('.testcase_title.active').removeClass('active')
        event.target.classList.add('active')
        
        $('.testcase_data_inner,active').removeClass('active')
        $(`.testcase_data_inner_${case_order}`).addClass('active')
    }


    // tabs 
    const tabHandler = (event, targetId) => {
        var target = event.target;
        var parent = target.parentNode;
        var activeTab  = parent.querySelector('.tab.active')
        activeTab.classList.remove('active')
        target.classList.add('active')

        var targetEle = $(`#${targetId}`)
        console.log(targetEle)
        targetEle.siblings().removeClass('active')
        targetEle.addClass('active')


    }

</script>
{% endcompress %}
{% endblock %}