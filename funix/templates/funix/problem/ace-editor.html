<script type="text/javascript">
  $(function () {
      function format(state) {
          if (!state.id) return state.text; // optgroup
          return state.text;
      }

      window.previous_template = '';

      function update_language_template() {
          var source = $('textarea#id_source');
          if (source.val() == window.previous_template.replace(/\r/g, '') || source.val() == '') {
              var lang_id = $('#id_language').val();
              var code = localStorage.getItem('submit:' + $('#id_language').val());

              function update_submit_area(code) {
                  window.previous_template = code;
                  source.val(code);
                  {% if submission %}
                    window.ace_source.getSession().setValue(code);
                  {% else %}
                    window.ace_source.getSession().setValue('');
                  {% endif %}
              }

              if (code != null) {
                  update_submit_area(code);
              } else {
                  $.get('{{ url('language_template_ajax') }}', {
                      id: lang_id
                  }).done(function (template) {
                      update_submit_area(template);
                  });
              }
          }
      }

      function makeDisplayData(data) {
          var site_data = data.attr('data-info');
          var judge_data = data.attr('data-judge-info');
          var display_data = site_data || judge_data;
          return display_data;
      }

      function formatSelection(state) {
          if (!state.id) return state.text; // optgroup
          var data = makeDisplayData($("option[data-id=" + state.id + "]"));
          return $('<span>').append($('<b>').text(state.text), ' (', data, ')');
      }

      // Terrible hack, adapted from https://github.com/select2/select2/issues/4436
      $.fn.select2.amd.define('select2/data/customAdapter', ['select2/results', 'select2/utils'], function (Result, Utils) {
          RefPresenter = function ($element, options, dataAdapter) {
              RefPresenter.__super__.constructor.call(this, $element, options, dataAdapter);
          };
          Utils.Extend(RefPresenter, Result);
          RefPresenter.prototype.bind = function (container, $container) {
              container.on('results:focus', function (params) {
                  var data = makeDisplayData($("option[data-id=" + params.data.id + "]"));
                  $("#result-version-info").text(data);
              });
              RefPresenter.__super__.bind.call(this, container, $container);
          };
          return RefPresenter;
      });

      var customAdapter = $.fn.select2.amd.require('select2/data/customAdapter');

      $("#id_language").select2({
          theme: '{{ DMOJ_SELECT2_THEME }}',
          templateResult: format,
          templateSelection: formatSelection,
          resultsAdapter: customAdapter
      });

      $('#id_language').on('select2:open', function (evt) {
          var dropdown = $('.select2-dropdown');
          if (!$('#result-version-info').length)
              dropdown.append($("<span id=\"result-version-info\">"));
          dropdown.attr('id', 'language-select2');
      });

      $('#id_judge').on('select2:open', function (evt) {
          var dropdown = $('.select2-dropdown');
          $('#result-version-info').remove();
          dropdown.attr('id', 'judge-select2');
      });

      $('#id_language').change(function () {
          var lang = $("#id_language").find("option:selected").attr('data-ace');
          window.ace_source.getSession().setMode("ace/mode/" + lang);
          update_language_template();
      });

      $('#ace_source').on('ace_load', function (e, editor) {
          window.aceEditor = editor;

          update_language_template();
          editor.commands.addCommand({
              name: 'save',
              bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
              exec: function () {
                  localStorage.setItem('submit:' + $('#id_language').val(), editor.getSession().getValue());
              }
          });
          editor.getSession().setUseWrapMode(true);
          editor.setFontSize(14);
          editor.setPrintMarginColumn(100);
          // uuuuvcomment ace pasting event
          editor.on("paste", e => {
            if (e.text.length < 200) return;

            alert("Please type your code manually, don't cheat!");
            let suspiciousInput = document.querySelector("input[name=suspicious_behaviors]");
            let value = JSON.parse(suspiciousInput.value);
            value.push(Math.round(Date.now()/1000));
            suspiciousInput.value = JSON.stringify(value);
          })
          // uuuuvcomment end ace pasting event
          editor.focus();
      });

      $('#problem_submit').submit(function (event) {
          if ($('#id_source').val().length > 65536) {
              alert("{{ _('Your source code must contain at most 65536 characters.') }}");
              event.preventDefault();
              $('#problem_submit').find(':submit').attr('disabled', false);
          }
      });
  });
</script>
