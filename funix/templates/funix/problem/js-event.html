<script type="text/javascript">
  $(function () {
      var blocked = false, request = false;
      var list = $('#test-cases');
      
        function update_more() {
            $("#loading-modal").remove();
            const submission_long_status = document.getElementById("event-update-submission-long-status").value;
            const submission_result = document.getElementById("event-update-submission-result").value

            if (submission_result == "AC") {
                document.getElementById("success-modal").classList.remove("d-none")
            }

            document.querySelector(".submission-history-long-status").classList.add(submission_result)
            document.querySelector(".submission-history-long-status").innerText = submission_long_status
        }

      function update() {
          if (blocked) {
              request = true;
              return;
          }
          request = false;
          blocked = true;
          $.ajax({
            {% if course %}
            url: '{{ url('beta_submission_testcases_query', course=course.slug) }}{% if iframe and iframe == "1" %}{{"?iframe=1"}}{% endif %}',
            {% else %}
            url: '{{ url('beta_submission_testcases_query') }}{% if iframe and iframe == "1" %}{{"?iframe=1"}}{% endif %}',
            {% endif %}
              data: {id: '{{ submission.id }}'}
          }).done(function (data) {
                const update_zone = document.getElementById('event-update')
                update_zone.innerHTML = data;


              list.empty().html(data).find('.toggle').each(function () {
                  register_toggle($(this));
              });

              $( "#testcases").tabs();
              $( ".testcases-and-submission").tabs();
              setTimeout(function () {
                  blocked = false;

                  if (request)
                      update();
              }, 500);
              if (document.getElementById("event-update-submission-result").value) {
                    update_more();
                }
          }).fail(function (data) {
              console.log('Failed to update testcases!');
              update_more();
              alert('Failed to update testcases!')
          });

          if ($(window).scrollTop() + $(window).height() > $(document).height() - 100)
              $("html, body").animate({scrollTop: $(document).height()}, 0);
      }

      var receiver = new EventReceiver(
          "{{ EVENT_DAEMON_LOCATION }}", "{{ EVENT_DAEMON_POLL_LOCATION }}",
          ['sub_{{ submission.id_secret }}'], {{ last_msg }}, function (message) {
              switch (message.type) {
                  case 'internal-error':
                  case 'grading-end':
                  case 'compile-error':
                      $('#abort-button').remove();
                      $('#grading-label').remove();
                  case 'test-case':
                  case 'grading-begin':
                  case 'processing':
                      update();

              }
          }
      )
  });
</script>
