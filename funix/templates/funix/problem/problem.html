{% extends 'funix/base.html' %} 

{% block media %} 
  {{ form.media.css }}
  <link rel="stylesheet" href="{{ static('funix/css/lib/jquery-ui.css') }}" />
  <link rel="stylesheet" href="{{ static('plugins/css/resizable.min.css') }}" />

  {# problem specific css #}
  <link rel="stylesheet" href="{{ static('funix/css/loading.css') }}" />
  <link rel="stylesheet" href="{{ static('funix/css/problem/base.css') }}" />
  <link rel="stylesheet" href="{{ static('funix/css/problem/sidebar.css') }}" />
  <link
    rel="stylesheet"
    href="{{ static('funix/css/problem/problem-content.css') }}"
  />
  <link rel="stylesheet" href="{{ static('funix/css/problem/topbar.css') }}" />
  <link
    rel="stylesheet"
    href="{{ static('funix/css/problem/main-middle.css') }}"
  />
  <link
    rel="stylesheet"
    href="{{ static('funix/css/problem/description.css') }}"
  />
  <link rel="stylesheet" href="{{ static('funix/css/problem/metadata.css') }}" />
  <link rel="stylesheet" href="{{ static('funix/css/problem/problem.css') }}" />
  <link
    rel="stylesheet"
    href="{{ static('funix/css/problem/html-preview.css') }}"
  />
  <link
    rel="stylesheet"
    href="{{ static('funix/css/problem/submission-history.css') }}"
  />
  <link rel="stylesheet" href="{{ static('funix/css/problem/modal.css') }}" />

  <style>
    {% if is_html %}
      #main-right {
        flex: 1;
        border-left: .5px solid var(--border);
      }

      @media screen and (max-width: 992px) {
        #main-right {
          border-left: none;
        }
      }
    {% else %}
      #main-middle {
        flex: 1;
      }
    {% endif %}

    {% if not request.user.is_authenticated %}
        #main-left {
          flex: 1;
          order: 1;
        }

        #login-required {
          order: 2;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          flex: 1;
          border-left: .5px solid var(--border);
        }

        @media screen and (max-width: 992px) {
          #login-required {
            height: 300px;
            border-left: none;
            border-bottom: .5px solid var(--border);
          }
        }
    {% endif %}
  </style>
{% endblock %} 

{% block js_media %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="{{static('plugins/js/resizable.min.js')}}" type="text/javascript"></script>
  <script type="text/javascript" src="{{ ACE_URL }}/ace.js"></script>
  {{ form.media.js }}
  <script type="text/javascript" src="{{ static('event.js') }}"></script>

  {% include 'funix/problem/ace-editor.html' %}

  {% if request.user.is_authenticated %}

    {% if is_html %}
      <script type="text/javascript">
        function update_iframe_height() {
          const iframe = document.querySelector("#html-preview iframe");
          iframe.style.height = 0;
          iframe.style.height = iframe.contentWindow.document.documentElement.scrollHeight + 20 + 'px';
        }
      </script>
    {% endif %}

    {% include "funix/problem/js-resizing.html" %} 
  
  {% endif %}

    {% include "funix/problem/js-tabs.html" %}

  {% if submission and not submission.is_graded and last_msg %} 
    {% include "funix/problem/js-event.html" %} 
  {% endif %} 

{% endblock %} 

  {% if submission %}
    {% set is_processing = submission is not none %} 
  {% endif %} 

{% block body %}
<div id="problem-container">
  <div id="sidebar-wrapper">{% include "funix/problem/sidebar.html" %}</div>

  <div id="problem-content-wrapper">
    <div id="problem-content">
      <div id="topbar">{% include "funix/problem/topbar.html" %}</div>

      <div id="main">
        {% if not request.user.is_authenticated %} {% include
        "funix/problem/login-required.html" %} {% endif %}

        <div id="main-left">
          {% include "funix/problem/details.html" %} {% include
          "funix/submission/history.html" %}
        </div>

        {% if request.user.is_authenticated %}
        <div id="main-middle">
          {% include 'funix/problem/editor.html' %} {% include
          'funix/submission/submission.html' %}
        </div>

        {% if is_html %}
        <div id="main-right">
          {% include "funix/problem/html-preview.html" %}
        </div>
        {% endif %} 
        {% endif %}
      </div>
    </div>
  </div>

  {% if submission and not submission.is_graded and (request.user == submission.user.user or perms.judge.abort_any_submission) %} 
    {% include "funix/problem/judging-modal.html" %} 
  {% endif %}
</div>

<script type="text/javascript">

  function expandEditor(event) {

    function save_prev_resizing() {
      {% if is_html %}
        localStorage.setItem("pre_html_mode_left_width", $("#main-left").width());
        localStorage.setItem("pre_html_mode_middle_width", $("#main-middle").width());
      {% else %}
        localStorage.setItem("pre_normal_mode_left_width", $("#main-left").width());
      {% endif %}
    }

    function restore_prev_resizing() {
      const pre_left_width = localStorage.getItem("{% if is_html %}{{ 'pre_html_mode_' }}{% else %}{{ 'pre_normal_mode_' }}{% endif %}left_width");
      if (pre_left_width && !isNaN(Number(pre_left_width))) {
        $("#main-left").width(Number(pre_left_width));
      }

      {% if is_html %}
        const pre_middle_width = localStorage.getItem("pre_html_mode_middle_width");
        if (pre_middle_width && !isNaN(Number(pre_middle_width))) {
          $("#main-middle").width(Number(pre_middle_width));
        }
      {% endif %}
    }

    function expand_middle() {
      $("#main-middle").width($("#main").width() + "px");
      $("#main-left").width(0);
      {% if is_html %}
      $("#main-right").width(0);
      {% endif %}
    }

    const middle = document.getElementById("main-middle");
    if (middle.classList.contains("expand")) {
      restore_prev_resizing();
    } else {
      save_prev_resizing();
      expand_middle();
    }
    middle.classList.toggle("expand");
  }

  {% if is_html %}
    const open_eye  = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>`
    
    const close_eye = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
    </svg>`    

    if (localStorage.getItem("hide_html_description") === "1") {
      document.getElementById("toggle-description-button").classList.add("active");
      document.getElementById("main-left").classList.add("d-none");
      document.getElementById("toggle-description-button").innerHTML = open_eye;
    }


    function toggleDescription(event) {
      document.getElementById("toggle-description-button").classList.toggle("active");

      if (document.getElementById("toggle-description-button").classList.contains("active")) {
        document.getElementById("toggle-description-button").innerHTML = open_eye;
        localStorage.setItem("hide_html_description", "1")
      } else {
        localStorage.setItem("hide_html_description", "0")
        document.getElementById("toggle-description-button").innerHTML = close_eye;
      }

      document.getElementById("main-left").classList.toggle("d-none");
    }
  {% endif %}

</script>

{% endblock %}
