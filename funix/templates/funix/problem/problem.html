{% extends 'base.html' %}
{% block media %}
    {{ form.media.css }}
    <link rel="stylesheet" href="{{ static('plugins/css/resizable.min.css') }}">
    <link rel="stylesheet" href="{{ static('funix/css/problem.css') }}">

    {% if iframe == '1' %}
    <style>
        /* display none navbar if being in iframe  */
        #navigation {
            display: none;
        }

        #page-container  #content-body {
            padding-top: 0;
        }
    </style>
    {% endif %}
{% endblock %}




{% block js_media %}
    <script src="{{static('plugins/js/resizable.min.js')}}" type="text/javascript"></script>
    <script type="text/javascript" src="{{ ACE_URL }}/ace.js"></script>
    {{ form.media.js }}

    {% compress js %}
        {% include 'funix/problem/ace-editor.html' %}
    {% endcompress %}

    <script type="text/javascript" src="{{ static('event.js') }}"></script>
    {% if submission and not submission.is_graded and last_msg %}
        {% include "funix/problem/js-event.html" %}
    {% endif %}

    {% if submission and not submission.is_graded %}
        <script type="text/javascript">
            $(function () {
                $(document).keydown(function(e) {
                    // Ctrl-Enter or Command-Enter
                    if ((e.metaKey || e.ctrlKey) && e.which == 13) {
                        $('#abort-button form').submit();
                    }
                });
            });
        </script>
    {% endif %}
    
{% endblock %}

{% block body %}

    {% if submission %}
        {% set is_processing = submission is not none %}
    {% endif %}

    {% if perms.judge.test_site %}
    {% if PREFERRED_STYLE_CSS is not none %}
    {% if PREFERRED_STYLE_CSS == 'dark/style.css' %}
        {% set is_dark = 1 %}
    {% endif %}
    {% endif %}
    {% endif %}

<div class="problem_container {% if is_dark == 1 %}{{ 'dark-theme' }}{% endif %}">
    <div class="topbar">
        <span> {% if content_title %}{{ content_title }}{% else %}{{ title }}{% endif %}</span>
    </div>

    <div class="sidebar">
        {% include "funix/problem/sidebar.html" %}
    </div>

    <div class="main">
        <div class="problem_details">
            {% include "funix/problem/problem-details.html" %}
        </div>
    

        <div class="codeplace">
            {% if not request.user.is_authenticated %}
                <div class="login_required_overlay">
                    <div>
                        <p>Login is needed to make submission</p>
                        <a href="{{ url('auth_login') }}?next={{ LOGIN_RETURN_PATH|urlencode }}">{{ _('Login!') }}</a>
                    </div>
                </div>
            {% else %}

                <div class="toolbar">
                    {% include "funix/problem/toolbar.html" %}
                </div>

                {# uuuuvcomment ------------------------- submission form ------------------------- #}
                <form id="problem_submit" method="POST">
                    {# uuuuvcomment ------------------------- choose languages ------------------------- #}
                    {% if not no_judges %}
                        <div id="language">
                            {{ form.language.errors }}
                            <div id="language-select">
                                <select id="id_language" name="language">
                                    {% for lang in form.fields.language.queryset %}
                                        <option 
                                            value="{{ lang.id }}" 
                                            data-id="{{ lang.id }}" 
                                            data-name="{{ lang.name }}"
                                            data-info="{{ lang.info }}" 
                                            data-ace="{{ lang.ace }}"
                                            data-judge-info="{{ runtime_versions(lang.runtime_versions()) }}"
                                            {% if lang.id == default_lang.id %}selected{% endif %}
                                        >
                                            {{ lang.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    {% endif %}

                    {# uuuuvcomment ------------------------- warning ------------------------- #}
                    <div class="codeplace_warning">
                        {% if not no_judges %}
                            {% if default_lang not in form.fields.language.queryset %}
                                <div class="alert alert-warning alert-dismissable">
                                    <a class="close">x</a>
                                    <b>{{ _('Warning!') }}</b>
                                    {{ _('Your default language, %(language)s, is unavailable for this problem and has been deselected.', language=bold(default_lang.name)) }}
                                </div>
                            {% endif %}
                    
                            {% if request.in_contest and submission_limit %}
                                {% if submissions_left > 0 %}
                                    <div class="alert alert-warning alert-dismissable">
                                        <a class="close">x</a>
                                        {% trans left=submissions_left -%}
                                            You have {{ left }} submission left
                                            {%- pluralize -%}
                                            You have {{ left }} submissions left
                                        {%- endtrans %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning alert-dismissable">
                                        <a class="close">x</a>
                                        {{ _('You have 0 submissions left') }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </div>

                    {# uuuuvcomment ------------------------- editor ------------------------- #}
                    <div class="codeplace_editor">
                        {% csrf_token %}
                        {{ form.non_field_errors() }}
                        <div id="submit-wrapper">
                            <div id="editor">
                                {{ form.source.errors }}
                                {{ form.source }}
                            </div>
                        </div>
                    </div>

                    {# uuuuvcomment ------------------------- submit button ------------------------- #}
                    {# uuuuvcomment ------------------ or no judge is available --------------------- #}
                    <div class="submitbar">
                        {% if no_judges %}
                            <span style="color: red">{{ _('No judge is available for this problem.') }}</span>
                        {% else %}
                            <div class="submit-bar">
                                <div>
                                    {{ form.judge }}
                                </div>

                                <div class="submitbar_buttons">
                                    <input id="submit-button"  type="submit" value="{% if submission %}{{ _('Resubmit!') }}{% else %}{{ _('Submit') }}{% endif %}" class="button accent"
                                    {% if request.in_contest and submission_limit and not submissions_left %}disabled{% endif %}>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </form>
           
                <div class="submission">
                    {# uuuuvcomment ------------------------- test cases ------------------------- #}

                    <ul class="tabs">
                 
                        <li class="tab {% if not is_processing == true %}{{'active'}}{% endif %}" onclick="tabHandler(event, 'testcases')" >Test cases</li>
                        <li class="tab {% if is_processing == true %}{{'active'}}{% endif %}" onclick="tabHandler(event, 'submission_results')">Console</li>


                    {# uuuuvcomment ------------------------- rejudge form ------------------------- #}
                        <div class="rejudge_wrapper">
                            {% if submission and perms.judge.rejudge_submission and not submission.is_locked %}
                            {% compress js %}
                                <script type="text/javascript">
                                    window.confirm_and_rejudge = function (form) {
                                        if (confirm("{{ _('Are you sure you want to rejudge?') }}")) {
                                            form.submit()
                                        }
                                    };
                                </script>
                            {% endcompress %}
                            {% if iframe == '1' %}
                                {% set iframe_query = '?iframe=1' %}
                            {% else %}
                                {% set iframe_query = '' %}
                            {% endif %}
                            <form id="rejudge_form" action="{{ url('beta_submission_rejudge') }}{{iframe_query}}" method="post">
                                {% csrf_token %}
                                <a href="#" onclick="confirm_and_rejudge(parentNode)" class="button">{{ _('Rejudge') }}</a>
                                <input type="hidden" name="id" value="{{ submission.id }}" />
                                <input type="hidden" name="path" value="{{ url('beta_problem', problem.code) }}" />
                            </form>
                        {% endif %}
                        </div>
                    </ul>

                    <div class="tab_contents">
                        <div id="testcases" class="tab_content {% if not is_processing == true %}{{'active'}}{% endif %}">
                            <ul class="tabs">
                                {% for case in testcases_map %}
                                    <li  onclick="tabHandler(event, 'testcase{{case.order}}')" class="tab {% if case.order == 1 %}{{ 'active' }}{% endif %} {% if case.sub_order %}{{'subcase'}}{% endif %}"  >
                                        {% if case.type == 'S' %}
                                            Batch {{case.batch_order}}
                                        {% elif case.sub_order %}
                                            Case {{case.sub_order}}
                                        {% else %}
                                            Test case {{case.batch_order}}
                                        {% endif %}
                                        {% if case.is_pretest == false %}
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                                            </svg>
                                        {% endif %}
                                    </li>
                                {% endfor %}

                            </ul>
                        
                            {% for case in problem.cases.all() %}
                                {% if case.type != 'E' %}
                                <div id="testcase{{case.order}}" class="tab_content {% if case.order == 1 %}{{ 'active' }}{% endif %}">
                                    <div class="inner">
                                        <p class="testcase_data_item">
                                            <label>Points:</label> 
                                            <span>{{case.points}}</span>
                                        </p>
                                
                                        <div  class="testcase_data_item">
                                            <label>Input:</label> 
                                            {% if case.data and case.is_pretest == true %}
                                               <div class="outer_wrapper">
                                                    <div class="inner_wrapper">
                                                    <pre >
                                                        {{case.data.input_data}}
                                                    </pre>
                                                    </div>
                                               </div>
                                            {% endif %}
                                        </div>
                        
                                        <div class="testcase_data_item">
                                            <label>Expected output:</label>
                                            {% if case.data and case.is_pretest == true %}
                                               <div class="outer_wrapper">
                                                    <div class="inner_wrapper">
                                                    <pre>
                                                        {{case.data.output_data}}
                                                    </pre>
                                                    </div>
                                               </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
 
                        <div id="submission_results" class="tab_content {% if is_processing == true %}{{'active'}}{% endif %}">
                            {% if submission and  not submission.is_graded and (request.user == submission.user.user or perms.judge.abort_any_submission) %}
                                <div id="abort-button" class="d-none" >
                                    {# uuuuvcomment ------------------------- abort form ------------------------- #}
                                    <form action="{{ url('submission_abort', submission.id) }}" method="post"
                                        title="{{ _('Press Ctrl-Enter or Command-Enter to abort.') }}">
                                        {% csrf_token %}
                                        <input style="float:left" type="submit" value="{{ _('Abort') }}" class="button"/>
                                    </form>
                                </div>
                            {% endif %}
    
                            {% if submission %}
                                <span class="submission-info">
                                    <span class="submission-date">
                                        {# uuuuvcomment ------------------------- submission info ------------------------- #}
                                        {% with date=submission.date|date(_('N j, Y, g:i a')), can_edit=submission.problem.is_editable_by(request.user) %}
                                            {% if can_edit and submission.judged_on %}
                                                {{ _('%(date)s on %(judge)s', date=date, judge=submission.judged_on.name) }}
                                            {% else %}
                                                {{ date }}
                                            {% endif %}
                                            <br>
                                            <span>{{ submission.language }}</span>
                                            {% if can_edit %}
                                                [<a href="{{ url('admin:judge_submission_change', submission.id) }}">{{ _('Admin') }}</a>]
                                            {% endif %}
                                        {% endwith %}
                                    </span>
                                </span>

        
    
                                {# uuuuvcomment ------------------------- submission results and loading ------------------------- #}
                                <div id="test-cases">{% include "funix/problem/submission-status.html" %}</div>
    
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% compress js %}
{% include "funix/problem/js-ace-editor-extra.html" %}
{% include "funix/problem/js-resizing.html" %}
{% include "funix/problem/js-tabs.html" %}

{% if iframe == '1' %}
    {% include "funix/problem/js-iframe.html" %}
{% endif %}

{% if is_dark == 1 %}
<script class="text/javascript">
    $(document).ready(function() {
        const body = document.body;
        console.log(body.classList)
        $('body').addClass('dark-theme');
    });
</script>
{% endif %}
{% endcompress %}

{% endblock %}